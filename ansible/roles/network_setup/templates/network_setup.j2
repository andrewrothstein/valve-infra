#!/bin/bash

set -e
set -u
set -o pipefail
set -x

find_nic --wait

# HACK: Give a little bit of time to QEmu to bring up the interface
sleep 1

cd /sys/class/net/
for nic in *; do
    ip link set $nic up
done

PRIVATE=`find_nic -r private`
PUBLIC=`find_nic -r public`

# Only rename the private interface, since the public one
ip link set $PRIVATE down
ip link set $PRIVATE name private
ip addr add {{private_interface_ip}}/24 dev private
ip link set private up

echo 1 > /proc/sys/net/ipv4/ip_forward

# name sure ci-gateway hostname can resolve on the gateway
printf "127.0.0.1\tci-gateway" >> /etc/hosts
