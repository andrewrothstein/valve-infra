#!/bin/bash

set -eu

# Generate a configuration file based on the default values, or the overriding
# env vars
[ -d ./config/ ] || mkdir ./config/
echo -e "DNS_SERVER=${DNS_SERVER:-10.0.0.6}
TMP_MOUNT=${TMP_MOUNT:-/mnt/tmp}
PERMANENT_MOUNT=${PERMANENT_MOUNT:-/mnt/permanent}
PRIVATE_INTERFACE=${PRIVATE_INTERFACE:-private}
" > ./config/prod.env

cat ./config/private.env >> ./config/prod.env

. ./config/prod.env

D=$(dirname $(readlink -f $0))

# Set the ip address for the private interface, which will be used

# FIXME: Rest of this script can run as a normal user, but these
# require something more than netdev membership it seems.
ip link set dev $PRIVATE_INTERFACE up
# FIXME: If the interface is already configured, this will fail. Flag
# it off for development, for now. RTNETLINK answers: File exists
ip addr add 10.42.0.1/24 dev $PRIVATE_INTERFACE || true

if [ ! -d $TMP_MOUNT ]; then
    echo "TMP_MOUNT path ($TMP_MOUNT) is not a directory"
    exit 1
fi

if [ ! -e /sys/class/net/$PRIVATE_INTERFACE ]; then
    echo "PRIVATE_INTERFACE ($PRIVATE_INTERFACE) does not exist"
    exit 1
fi

# The hierachy is like /persistent_root/nfs-roots/board_name/{init,usr,bin,etc,...}
NFS_ROOTS=${TMP_MOUNT}/nfs-roots

genroot()
{
    ROOTFS=$1
    [ ! -d "$ROOTFS" ] && mkdir -pv "$ROOTFS"

    echo "exporting rootfs..."
    cat <<EOF | docker build -t radv-infra-default-image -
FROM debian:testing
RUN apt-get -qy update && apt-get -qy install --no-install-recommends linux-image-amd64 systemd-sysv
RUN passwd root -d
EOF
    CID=$(docker run -d radv-infra-default-image /bin/true)
    docker export $CID | tar x -C $ROOTFS
    docker stop $CID
}

# FIXME: Drive this from a static configuration of the known network (a config file)
if [ ! -d  $NFS_ROOTS ]; then
    echo "nfs-roots are not present in $TMP_MOUNT, initializing them..."
    mkdir -pv ${NFS_ROOTS}/igalia-amd-gfx8-1
    mkdir -pv ${NFS_ROOTS}/igalia-amd-gfx8-2

    # Create something hopefully bootable for stuff not otherwise configured.
    genroot "${NFS_ROOTS}/default"
fi

# Autoconfiguration will see to it that these "static" configuration
# files are no longer needing to be copied like this
rsync --delete -av ./component-farm/nfs/ $TMP_MOUNT/nfs/
rsync --delete -av ./component-farm/tftp/ $TMP_MOUNT/tftp/
rsync --delete -av ./component-farm/dhcp/ $TMP_MOUNT/dhcp/

if [ -n "$GITLAB_REGISTRATION_TOKEN" ] && [ -n "$GITLAB_ACCESS_TOKEN" ]; then
    [ -d $PERMANENT_MOUNT/gitlab-runner ] || mkdir $PERMANENT_MOUNT/gitlab-runner
    ./gitlab-runner-sync --registration-token $GITLAB_REGISTRATION_TOKEN \
                         --access-token $GITLAB_ACCESS_TOKEN \
                         --machine-data machines.db \
                         --gitlab-config $PERMANENT_MOUNT/gitlab-runner/config.toml
fi

docker-compose --env-file ./config/prod.env pull
docker-compose --env-file ./config/prod.env up
